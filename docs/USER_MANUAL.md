# M3U8 Web 下载器 - 使用手册

本文档面向最终用户，说明如何安装、启动以及使用 Web 界面完成 M3U8 下载与常见问题处理。

---

## 1. 安装与启动

### 1.1 环境要求

- 已安装 **Node.js 14** 或更高版本（推荐 LTS）。
- 终端或命令行可用（Windows 可用 CMD、PowerShell；macOS/Linux 用终端）。

### 1.2 安装依赖

在项目根目录执行：

```bash
npm install
```

若网络较慢，可使用国内镜像，例如：

```bash
npm install --registry=https://registry.npmmirror.com
```

### 1.3 启动服务

```bash
npm start
```

看到类似输出即表示启动成功：

```
Server running at http://localhost:3000
```

在浏览器中打开：**http://localhost:3000**。

---

## 2. 界面说明

### 2.1 顶部：添加任务

- **输入框**：粘贴 M3U8 播放列表链接（通常以 `.m3u8` 结尾或链接内容为 m3u8 文本）。
- **「添加任务」按钮**：点击或按 **回车** 提交，任务会进入右侧「等待队列」。

### 2.2 左侧主区域：任务详情

当在右侧选中某个任务后，此处显示：

- **顶部信息**：任务 URL、当前进度百分比、成功分片数/总分片数。
- **进度条**：绿色表示已完成，蓝色表示进行中。
- **提示与操作**：  
  - “点击红色方块可手动重试” —— 失败分片会显示为红色小块，点击可重试该分片。  
  - **「强制合并」** —— 不等待全部分片成功，将已成功的分片合并为一个 MP4（可能不完整）。
- **分片网格**：每个小格代表一个分片，颜色含义：
  - **灰色**：未开始或待重试  
  - **蓝色（闪烁）**：正在下载  
  - **绿色**：下载成功  
  - **红色**：下载失败，可点击重试  
- **底部日志**：该任务的运行日志（解析、下载、合并、报错等），仅对当前选中的任务有效。

若当前未选中任何任务，会显示“请从右侧列表选择一个任务查看详情”。

### 2.3 右侧：队列与任务列表

- **⏳ 等待队列**：已添加但尚未开始的任务，按添加顺序排队，数字为当前等待数量。
- **📜 任务列表 (含历史)**：  
  - 若有正在运行的任务，会置顶并标“Running”和绿点动画。  
  - 下方为历史任务（包括已完成、失败、等待重试等）。  
  - 点击某一项可切换左侧详情；鼠标悬停可显示 **重新下载**、**删除** 按钮。

---

## 3. 基本使用流程

### 3.1 下载一个 M3U8 视频

1. 获取 M3U8 链接（从浏览器开发者工具、抓包工具或站点提供的“m3u8 地址”等）。
2. 在顶部输入框粘贴该链接，点击「添加任务」或按回车。
3. 任务出现在右侧「等待队列」；若当前没有正在运行的任务，会自动开始，并出现在「任务列表」顶部为“Running”。
4. 点击该任务，左侧会显示分片网格与进度；全部成功后会自动合并。
5. 合并完成后，视频文件位于项目目录下的 **`downloads/<任务ID>/output.mp4`**。任务 ID 可在任务列表或详情中看到（通常显示后几位）。

### 3.2 部分分片失败时

- **重试单个分片**：在左侧分片网格中，点击 **红色** 小块，会只重试该分片。
- **强制合并**：若不想继续重试，可点击「强制合并」，将已成功的分片合并为 `output.mp4`（可能缺段或无法正常播放，视情况而定）。

### 3.3 重新下载（清空进度再来一次）

- 在右侧任务列表中，将鼠标悬停到对应任务上，点击 **重新下载** 图标（循环箭头）。
- 确认后，该任务会清空原有下载文件并重新进入队列，从头解析与下载。

### 3.4 删除任务

- 在右侧任务列表中，悬停到对应任务，点击 **删除** 图标（垃圾桶）。
- 确认后，会删除该任务在列表中的记录以及 **`downloads/<任务ID>`** 下所有文件。  
- **注意**：正在运行的任务无法删除，需等其完成或先重启服务再删。

### 3.5 任务一直“解析失败”或“等待重试”

- 若详情里提示“未能获取分片列表”或长时间无分片网格，可点击 **「重新开始任务」**（或到列表里对该任务使用「重新下载」），有时是临时网络问题。
- 若多次仍失败，请检查：  
  - M3U8 链接在浏览器中能否直接打开并看到文本内容；  
  - 是否需要登录、Cookie 或特定 Referer（本程序使用固定 Referer/User-Agent，复杂站点可能不支持）。

---

## 4. 下载文件位置与命名

- 每个任务单独一个目录：**`downloads/<任务ID>/`**。
- 合并后的视频文件名为：**`output.mp4`**，完整路径示例：`downloads/1738123456789/output.mp4`。
- 任务 ID 在界面“任务列表”和详情中会显示（多为时间戳，界面常只显示后几位）。

---

## 5. 常见问题（FAQ）

**Q：支持哪些链接？**  
A：支持通过 HTTP/HTTPS 直接可访问的 M3U8 地址。若站点用 Cookie、登录或复杂防盗链，可能无法下载。

**Q：为什么合并后的 MP4 无法播放？**  
A：本工具是简单按顺序拼接 TS 分片，未做重新编码。若源流编码或封装特殊，可能需用 ffmpeg 等工具再处理；若强制合并时缺了部分分片，文件也会不完整。

**Q：可以同时下载多个任务吗？**  
A：不可以。当前设计为同一时间只运行一个任务，其余在“等待队列”中依次执行。

**Q：关闭浏览器会影响下载吗？**  
A：不会。下载在服务器（本机）进行，关闭浏览器只断开实时进度显示；再次打开页面并连接同一服务，仍能看到队列与任务状态。但若关闭运行 `npm start` 的终端（即关闭服务），当前任务会中断，重启后该任务会出现在历史中且状态为“等待重试”。

**Q：如何彻底清空所有任务和下载？**  
A：停止服务后，可手动删除项目根目录下的 **`data.json`** 以及 **`downloads`** 文件夹（或其中子文件夹），再启动服务即可从空状态开始。

**Q：端口 3000 被占用怎么办？**  
A：需修改 `server.js` 中的 `const PORT = 3000` 为其他未占用端口，保存后重新执行 `npm start`，并在浏览器访问新端口。

---

## 6. 文档与支持

- **项目说明与快速开始**：[README.md](../README.md)
- **开发与扩展**：[docs/DEVELOPMENT.md](DEVELOPMENT.md)
- **API 与实现细节**：[docs/TECHNICAL.md](TECHNICAL.md)

若用于学习或个人合法使用，请遵守目标网站的使用条款与版权规定。
