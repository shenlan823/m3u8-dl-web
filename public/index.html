<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Vue M3U8 ä¸‹è½½å™¨</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<style>
		::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 4px;
		}

		.status-transition {
			transition: background-color 0.3s ease;
		}
	</style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800">

	<div id="app" class="p-4 md:p-8 max-w-7xl mx-auto space-y-6">

		<!-- å¤´éƒ¨ -->
		<div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
			<h1 class="text-2xl font-bold text-gray-800 mb-4">M3U8 ä¸‹è½½æ§åˆ¶å°</h1>
			<div class="flex gap-3">
				<input v-model="inputUrl" @keyup.enter="addUrl" type="text" placeholder="è¾“å…¥ M3U8 é“¾æ¥"
					class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
				<button @click="addUrl" :disabled="!inputUrl"
					class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50">æ·»åŠ ä»»åŠ¡</button>
			</div>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

			<!-- å·¦ä¾§ï¼šä¸»é¢æ¿ (æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„ä»»åŠ¡è¯¦æƒ…) -->
			<div class="lg:col-span-2">
				<div v-if="viewingJob.id"
					class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden sticky top-6">
					<!-- é¡¶éƒ¨ä¿¡æ¯ -->
					<div class="p-6 border-b bg-gray-50/50">
						<div class="flex justify-between items-start mb-4">
							<div>
								<div class="flex items-center gap-2">
									<span v-if="viewingJob.id === activeJobId"
										class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-bold">è¿è¡Œä¸­</span>
									<span v-else
										class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded font-bold">å†å²è®°å½•</span>
									<h2 class="text-lg font-bold">ä»»åŠ¡è¯¦æƒ…</h2>
								</div>
								<p class="text-xs text-gray-500 truncate mt-1 max-w-md"
									:title="viewingJob.url">{{ viewingJob.url }}</p>
							</div>
							<div class="text-right">
								<div
									class="text-3xl font-black text-blue-600 font-mono">
									{{ progressPercent }}%</div>
								<div class="text-xs text-gray-400">æˆåŠŸ: {{ successCount
									}} / {{ totalSegments }}</div>
							</div>
						</div>

						<!-- è¿›åº¦æ¡ -->
						<div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
							<div class="h-2.5 rounded-full transition-all duration-300"
								:class="isCompleted ? 'bg-green-500' : 'bg-blue-600'"
								:style="{ width: progressPercent + '%' }"></div>
						</div>

						<!-- æ“ä½œ -->
						<div class="flex justify-between items-center">
							<div class="text-xs text-gray-500">
								æç¤º: ç‚¹å‡»çº¢è‰²æ–¹å—å¯æ‰‹åŠ¨é‡è¯•
							</div>
							<button @click="forceMerge"
								class="text-xs bg-amber-100 text-amber-700 px-3 py-1.5 rounded hover:bg-amber-200 border border-amber-200">
								å¼ºåˆ¶åˆå¹¶
							</button>
						</div>
					</div>

					<!-- ç½‘æ ¼ -->
					<!-- ä¿®æ”¹ HTML ä¸­çš„ç½‘æ ¼æ˜¾ç¤ºé€»è¾‘ -->
					<div class="p-1 max-h-[400px] overflow-y-auto bg-gray-50/50">
						<!-- æƒ…å†µ1: æœ‰åˆ†ç‰‡æ•°æ®ï¼Œæ­£å¸¸æ˜¾ç¤ºç½‘æ ¼ -->
						<div v-if="segments.length > 0"
							class="grid grid-cols-[repeat(auto-fill,minmax(12px,1fr))] gap-[2px] p-2">
							<div v-for="seg in segments" :key="seg.index"
								:title="`åˆ†ç‰‡ #${seg.index}\nçŠ¶æ€: ${seg.status}`"
								@click="handleSegmentClick(seg)"
								class="h-3 rounded-[2px] status-transition cursor-default"
								:class="{
					                'bg-gray-200': seg.status === 'pending' || seg.status === 'retry',
					                'bg-blue-500 animate-pulse': seg.status === 'downloading',
					                'bg-green-500': seg.status === 'success',
					                'bg-red-500 cursor-pointer hover:ring-2 ring-red-300': seg.status === 'failed'
					            }"></div>
						</div>

						<!-- æƒ…å†µ2: æ²¡åˆ†ç‰‡ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯ç­‰å¾…é‡è¯•ï¼ˆè¯´æ˜è§£æå°±æŒ‚äº†ï¼‰ -->
						<div v-else-if="viewingJob.status === 'waiting_retry' || viewingJob.status === 'error'"
							class="flex flex-col items-center justify-center py-10 text-gray-500 gap-3">
							<div class="text-4xl">âš ï¸</div>
							<p>ä»»åŠ¡åˆå§‹åŒ–/è§£æå¤±è´¥</p>
							<p class="text-xs text-gray-400">æœªèƒ½è·å–åˆ†ç‰‡åˆ—è¡¨ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–é“¾æ¥æ— æ•ˆ</p>
							<button @click="restartJob"
								class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition">
								ğŸ”„ é‡æ–°å¼€å§‹ä»»åŠ¡
							</button>
						</div>

						<!-- æƒ…å†µ3: æ²¡åˆ†ç‰‡ï¼Œæ˜¯å…¶ä»–çŠ¶æ€ -->
						<div v-else class="text-center py-10 text-gray-400 text-sm">
							<span v-if="viewingJob.url === 'Loading...'">æ­£åœ¨åŠ è½½ä»»åŠ¡ä¿¡æ¯...</span>
							<span v-else>ç­‰å¾…è§£æåˆ†ç‰‡åˆ—è¡¨...</span>
						</div>
					</div>

					<!-- æ—¥å¿— -->
					<div class="bg-gray-900 text-gray-300 text-xs font-mono p-4 h-40 overflow-y-auto border-t border-gray-800"
						ref="logContainer">
						<div v-for="(log, idx) in logs" :key="idx" class="mb-1 break-all"
							:class="{'text-red-400': log.isError, 'text-green-400': log.isSuccess}">
							<span class="opacity-50">[{{ log.time }}]</span> {{ log.text }}
						</div>
					</div>
				</div>

				<div v-else
					class="bg-white rounded-xl shadow-sm p-12 text-center border border-dashed border-gray-300">
					<div class="text-4xl mb-4">ğŸ‘ˆ</div>
					<p class="text-gray-500">è¯·ä»å³ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªä»»åŠ¡æŸ¥çœ‹è¯¦æƒ…</p>
				</div>
			</div>

			<!-- å³ä¾§ï¼šåˆ—è¡¨åŒº -->
			<div class="space-y-6">

				<!-- ç­‰å¾…é˜Ÿåˆ— -->
				<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
					<div
						class="p-3 bg-gray-50 font-bold text-sm text-gray-700 border-b flex justify-between">
						<span>â³ ç­‰å¾…é˜Ÿåˆ—</span>
						<span class="bg-blue-100 text-blue-800 text-xs px-2 rounded-full">{{
							queue.length }}</span>
					</div>
					<ul class="max-h-60 overflow-y-auto">
						<li v-for="(item, idx) in queue" :key="item.id"
							class="p-3 border-b last:border-0 hover:bg-gray-50 text-sm">
							<div class="font-medium truncate text-gray-600">ID: {{
								item.id.slice(-4) }}</div>
							<div class="text-xs text-gray-400 truncate">{{ item.url }}</div>
						</li>
						<li v-if="queue.length === 0"
							class="p-4 text-center text-gray-400 text-xs">ç©º</li>
					</ul>
				</div>

				<!-- å†å²è®°å½• (åŒ…å« Active) -->
				<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
					<div class="p-3 bg-gray-50 font-bold text-sm text-gray-700 border-b">
						ğŸ“œ ä»»åŠ¡åˆ—è¡¨ (å«å†å²)
					</div>
					<ul class="max-h-[500px] overflow-y-auto">
						<!-- å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„ï¼Œæ‰‹åŠ¨ç½®é¡¶æ˜¾ç¤º -->
						<li v-if="activeJobId" @click="loadJobDetails(activeJobId)"
							class="p-3 border-b border-blue-100 bg-blue-50 cursor-pointer hover:bg-blue-100 transition relative">
							<div
								class="absolute right-2 top-2 w-2 h-2 bg-green-500 rounded-full animate-ping">
							</div>
							<div class="font-bold text-blue-700 text-sm">Running: {{
								activeJobId.slice(-4) }}</div>
							<div class="text-xs text-blue-600 mt-1">ç‚¹å‡»æŸ¥çœ‹å®æ—¶è¿›åº¦</div>
						</li>

						<!-- å†å²åˆ—è¡¨ -->
						<li v-for="h in history" :key="h.id"
							class="p-3 border-b last:border-0 hover:bg-gray-50 transition group flex justify-between items-start"
							:class="{'bg-gray-100': viewingJob.id === h.id}">

							<!-- å·¦ä¾§å†…å®¹åŒºåŸŸ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…) -->
							<div @click="loadJobDetails(h.id)"
								class="cursor-pointer flex-1">
								<div class="flex items-center gap-2 mb-1">
									<span class="font-medium text-sm text-gray-700">{{
										h.id.slice(-4) }}</span>

									<!-- çŠ¶æ€å¾½æ ‡ï¼šå¦‚æœæ˜¯ completed æ˜¾ç¤ºç»¿è‰²ï¼Œå¦åˆ™æ ¹æ®æˆåŠŸæ•°æ˜¾ç¤º -->
									<span class="text-xs px-1.5 rounded"
										:class="h.status === 'completed' || (h.successCount === h.totalCount && h.totalCount > 0) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
										{{ h.status === 'completed' ? 'å®Œæˆ' :
										h.successCount + '/' + h.totalCount }}
									</span>
								</div>
								<div class="text-xs text-gray-400 truncate w-48">{{
									h.url }}</div>
							</div>

							<!-- å³ä¾§æŒ‰é’®ç»„ (é»˜è®¤éšè—ï¼Œhoveræ˜¾ç¤º) -->
							<div
								class="flex gap-1 opacity-0 group-hover:opacity-100 transition items-center">

								<!-- é‡æ–°ä¸‹è½½æŒ‰é’® -->
								<button @click.stop="triggerRestart(h.id)"
									title="é‡æ–°ä¸‹è½½ (æ¸…ç©ºè¿›åº¦)"
									class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition">
									<svg xmlns="http://www.w3.org/2000/svg"
										class="h-4 w-4" fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor">
										<path stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
									</svg>
								</button>

								<!-- åˆ é™¤æŒ‰é’® -->
								<button @click.stop="deleteJob(h.id)" title="åˆ é™¤ä»»åŠ¡"
									class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition">
									<svg xmlns="http://www.w3.org/2000/svg"
										class="h-4 w-4" fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor">
										<path stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
									</svg>
								</button>
							</div>
						</li>
					</ul>
				</div>

			</div>
		</div>
	</div>

	<script>
		const { createApp } = Vue;

		createApp({
			data() {
				return {
					inputUrl: '',
					queue: [],
					history: [],
					activeJobId: null, // å½“å‰æœåŠ¡å™¨æ­£åœ¨è·‘çš„ä»»åŠ¡ID

					// å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ä»»åŠ¡ï¼ˆå¯èƒ½æ˜¯æ­£åœ¨è·‘çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å†å²çš„ï¼‰
					viewingJob: { id: null, url: '' },
					segments: [],
					logs: []
				}
			},
			computed: {
				totalSegments() { return this.segments.length; },
				successCount() { return this.segments.filter(s => s.status === 'success').length; },
				progressPercent() {
					if (this.totalSegments === 0) return 0;
					return ((this.successCount / this.totalSegments) * 100).toFixed(1);
				},
				isCompleted() { return this.totalSegments > 0 && this.successCount === this.totalSegments; }
			},
			mounted() {
				this.initSSE();
			},
			methods: {
				initSSE() {
					const evtSource = new EventSource("/api/events");
					evtSource.onmessage = (event) => {
						const msg = JSON.parse(event.data);

						// 1. é˜Ÿåˆ—ä¸çŠ¶æ€æ›´æ–°
						if (msg.type === 'queue-update') {
							this.queue = msg.data.queue;
							this.history = msg.data.history;
							this.activeJobId = msg.data.activeId;

							// ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰æ­£åœ¨çœ‹çš„ï¼Œä¸”æœ‰æ­£åœ¨è·‘çš„ï¼Œè‡ªåŠ¨é€‰ä¸­æ­£åœ¨è·‘çš„
							if (!this.viewingJob.id && this.activeJobId) {
								this.loadJobDetails(this.activeJobId);
							}
						}
						// 2. æ–°ä»»åŠ¡å¼€å§‹
						else if (msg.type === 'job-start') {
							// å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹æ—§ä»»åŠ¡ï¼Œå¯ä»¥ä¸æ‰“æ–­ï¼›æˆ–è€…æç¤ºã€‚
							// è¿™é‡Œé€‰æ‹©ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ä»»åŠ¡
							this.activeJobId = msg.data.id;
							this.loadJobDetails(msg.data.id);
						}
						// 3. æ—¥å¿— (åªæœ‰å½“æŸ¥çœ‹çš„ä»»åŠ¡ ID åŒ¹é…æ—¥å¿—çš„ JobID æ—¶æ‰å¤„ç†)
						else if (msg.event === 'log') {
							const payload = msg.payload;
							if (payload.jobId !== this.viewingJob.id) return;

							this.processLog(payload);
						}
					};
				},

				// åŠ è½½ä»»åŠ¡è¯¦æƒ…ï¼ˆæ— è®ºæ˜¯æ­£åœ¨è¿è¡Œè¿˜æ˜¯å†å²ï¼‰
				// ä¿®æ”¹ loadJobDetailsï¼Œå¢åŠ  status çš„ä¿å­˜
				async loadJobDetails(id) {
					if (this.viewingJob.id === id) return;

					this.viewingJob = { id, url: 'Loading...', status: '' }; // åˆå§‹åŒ– status
					this.segments = [];
					this.logs = [];

					try {
						const res = await fetch(`/api/job/${id}`);
						if (!res.ok) throw new Error("Load failed");
						const data = await res.json();

						// ç»‘å®šæ›´å¤šæ•°æ®
						this.viewingJob = { id: data.id, url: data.url, status: data.status };
						this.segments = data.segments || []; // é˜²æ­¢ null

						this.addLog(`å·²åŠ è½½ä»»åŠ¡è¯¦æƒ…: ${id}`);

						// é’ˆå¯¹è§£æå¤±è´¥çš„æƒ…å†µå¢åŠ æ—¥å¿—æç¤º
						if (this.segments.length === 0 && (data.status === 'waiting_retry' || data.status === 'error')) {
							this.addLog("é”™è¯¯: M3U8 è§£æå¤±è´¥ï¼Œæœªæ‰¾åˆ°åˆ†ç‰‡ã€‚è¯·ç‚¹å‡»é‡è¯•æŒ‰é’®ã€‚", true);
						}
					} catch (e) {
						this.addLog("åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥", true);
					}
				},

				// 1. æ–°å¢é€šç”¨é‡å¯æ–¹æ³•
				async triggerRestart(id) {
					if (!confirm('ç¡®å®šè¦é‡æ–°ä¸‹è½½å—ï¼Ÿ\nè¿™å°†æ¸…ç©ºæ—§æ–‡ä»¶å¹¶ä»å¤´å¼€å§‹ã€‚')) return;

					// UI ç«‹å³åé¦ˆï¼ˆå¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¥ä»»åŠ¡ï¼‰
					if (this.viewingJob.id === id) {
						this.addLog("æ­£åœ¨å‘é€é‡ç½®è¯·æ±‚...");
					}

					try {
						const res = await fetch('/api/restart', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ jobId: id })
						});

						if (res.ok) {
							this.addLog(`ä»»åŠ¡ ${id.slice(-4)} å·²é‡ç½®å¹¶åŠ å…¥é˜Ÿåˆ—`);

							// å¦‚æœåˆ—è¡¨é‡Œæœ‰æ­£åœ¨æŸ¥çœ‹çš„ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦åˆ·æ–°ä¸€ä¸‹çŠ¶æ€
							// SSE ä¼šå¤„ç†å¤§éƒ¨åˆ†æ›´æ–°ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è®© viewingJob å˜æ›´ä¸º loading
							if (this.viewingJob.id === id) {
								this.viewingJob.status = 'queued';
								this.segments = [];
							}
						} else {
							alert("é‡ç½®è¯·æ±‚å¤±è´¥");
						}
					} catch (e) {
						alert("ç½‘ç»œè¯·æ±‚é”™è¯¯");
					}
				},

				// 2. ä¿®æ”¹åŸæœ¬è¯¦æƒ…é¡µçš„ restartJob æ–¹æ³•ï¼Œè®©å®ƒè°ƒç”¨ä¸Šé¢çš„é€šç”¨æ–¹æ³•
				async restartJob() {
					if (!this.viewingJob.id) return;
					// ç›´æ¥è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•
					await this.triggerRestart(this.viewingJob.id);
				},

				async deleteJob(id) {
					if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ä»»åŠ¡è®°å½•åŠæ‰€æœ‰ä¸‹è½½æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

					// å¦‚æœæ­£åœ¨æŸ¥çœ‹è¿™ä¸ªè¦åˆ é™¤çš„ä»»åŠ¡ï¼Œå…ˆæ¸…ç©ºé¢æ¿
					if (this.viewingJob.id === id) {
						this.viewingJob = { id: null, url: '' };
						this.segments = [];
						this.logs = [];
					}

					try {
						const res = await fetch(`/api/job/${id}`, { method: 'DELETE' });
						const data = await res.json();

						if (res.ok) {
							this.addLog(`ä»»åŠ¡ ${id} å·²åˆ é™¤`);
							// SSE ä¼šè‡ªåŠ¨æ›´æ–°åˆ—è¡¨ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
						} else {
							alert(data.error || 'åˆ é™¤å¤±è´¥');
						}
					} catch (e) {
						alert('ç½‘ç»œè¯·æ±‚å¤±è´¥');
					}
				},

				processLog(payload) {
					switch (payload.type) {
						case 'init-segments':
							this.segments = payload.data;
							break;
						case 'segment-update':
							// å±€éƒ¨æ›´æ–°ï¼Œé«˜æ€§èƒ½
							const idx = this.segments.findIndex(s => s.index === payload.data.index);
							if (idx !== -1) this.segments[idx] = payload.data;
							break;
						case 'info': this.addLog(payload.data); break;
						case 'error': this.addLog(payload.data, true); break;
						case 'done': this.addLog(`å®Œæˆã€‚è¾“å‡º: ${payload.data.outputFile}`, false, true); break;
					}
				},

				async addUrl() {
					if (!this.inputUrl) return;
					await fetch('/api/add', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ url: this.inputUrl })
					});
					this.inputUrl = '';
				},

				handleSegmentClick(seg) {
					if (seg.status === 'failed') {
						this.retrySegment(seg.index);
					}
				},

				async retrySegment(index) {
					if (!this.viewingJob.id) return;

					// UI ä¹è§‚æ›´æ–°
					const idx = this.segments.findIndex(s => s.index === index);
					if (idx !== -1) this.segments[idx].status = 'downloading';

					this.addLog(`è¯·æ±‚é‡è¯•åˆ†ç‰‡ #${index}`);

					await fetch('/api/retry-segment', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ jobId: this.viewingJob.id, segmentIndex: index })
					});
				},

				async forceMerge() {
					if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åˆå¹¶å—ï¼Ÿ')) return;
					await fetch('/api/force-merge', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ jobId: this.viewingJob.id })
					});
				},

				addLog(text, isError = false, isSuccess = false) {
					this.logs.push({ time: new Date().toLocaleTimeString(), text, isError, isSuccess });
					this.$nextTick(() => {
						const c = this.$refs.logContainer;
						if (c) c.scrollTop = c.scrollHeight;
					});
				}
			}
		}).mount('#app');
	</script>
</body>

</html>